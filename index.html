<script type="text/babel">
        // 1. Initialize Gun with a Robust Peer Cluster
        // We use multiple peers so if one is "sleeping", others can take over.
        const gun = Gun([
            'https://gun-manhattan.herokuapp.com/gun',
            'https://gun-us.herokuapp.com/gun',
            'https://gun-eu.herokuapp.com/gun',
            'https://relay.peer.ooo/gun'
        ]);
        
        // GLOBAL USER VARIABLE (Declared only once)
        const user = gun.user();

        // 2. Main App Component
        function App() {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [myStatus, setMyStatus] = React.useState('offline'); 
            const [pubKey, setPubKey] = React.useState('');
            const [providers, setProviders] = React.useState({});
            const [lastPing, setLastPing] = React.useState(Date.now());

            // Effect: Check Login & Listen for Data
            React.useEffect(() => {
                // Persistent Login Check
                user.recall({sessionStorage: true}, (ack) => {
                    if (ack && ack.sea) {
                        setIsLoggedIn(true);
                        setPubKey(ack.sea.pub);
                    }
                });

                // GLOBAL LISTENER: Listen for updates from the mesh
                gun.get('ippolive_global_v1').map().on((data, key) => {
                    if(data) {
                        setProviders(prev => ({...prev, [key]: data}));
                    }
                });
            }, []);

            // Action: Login (Anonymous)
            const login = () => {
                const pair = Gun.SEA.pair((pair) => {
                    user.auth(pair, () => {
                        setIsLoggedIn(true);
                        setPubKey(pair.pub);
                    });
                });
            };

            // Action: Toggle Status
            const toggleStatus = () => {
                const newStatus = myStatus === 'offline' ? 'online' : 'offline';
                setMyStatus(newStatus);
                if (navigator.vibrate) navigator.vibrate(50); 

                const timestamp = Date.now();
                const data = { 
                    status: newStatus, 
                    lastUpdated: timestamp,
                    name: "Doctor " + (pubKey ? pubKey.substring(0, 4) : "Anon")
                };
                
                // Save to Graph
                user.get('profile').put(data);
                gun.get('ippolive_global_v1').get(pubKey).put(data);
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <h2>IppoLive Pilot</h2>
                        {!isLoggedIn ? (
                            <button onClick={login} style={{padding: '10px 20px', fontSize: '16px'}}>
                                Start (I am a Provider)
                            </button>
                        ) : (
                            <div>
                                <p>You are the Provider</p>
                                <div className="user-id">ID: {pubKey ? pubKey.substring(0, 10) : "..."}...</div>
                            </div>
                        )}
                    </div>

                    {isLoggedIn && (
                        <div>
                            <button 
                                className={`status-btn ${myStatus}`} 
                                onClick={toggleStatus}
                            >
                                {myStatus === 'online' ? "I AM IN" : "I AM OUT"}
                            </button>
                            <p style={{color: '#666'}}>Tap to change availability</p>
                        </div>
                    )}

                    {/* CONSUMER VIEW (Smart List) */}
                    <div className="provider-list">
                        <h3>Live Neighborhood Map</h3>
                        {Object.keys(providers).length === 0 && <p>Scanning for doctors...</p>}
                        
                        {Object.keys(providers).map(key => {
                            const p = providers[key];
                            // DEAD MAN'S SWITCH: 10 mins threshold
                            const now = Date.now();
                            const diff = now - (p.lastUpdated || 0);
                            const isStale = diff > 600000; 
                            const isOnline = !isStale && p.status === 'online';

                            return (
                                <div className="provider-item" key={key}>
                                    <div>
                                        <strong>{p.name || "Unknown"}</strong>
                                        <div style={{fontSize: '12px', color: '#888'}}>
                                            {isStale ? "⚠️ Signal Lost: " : "Updated: "}
                                            {p.lastUpdated ? new Date(p.lastUpdated).toLocaleTimeString() : "Never"}
                                        </div>
                                    </div>
                                    <div style={{display:'flex', alignItems:'center', gap:'5px'}}>
                                        <span className="dot" style={{background: isStale ? 'grey' : (isOnline ? '#4CAF50' : '#f44336')}}></span>
                                        <span style={{fontWeight: 'bold', color: isStale ? 'grey' : (isOnline ? '#4CAF50' : '#f44336')}}>
                                            {isStale ? "UNKNOWN" : (isOnline ? "OPEN" : "CLOSED")}
                                        </span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>