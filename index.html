<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IppoLive - Hyperlocal Presence</title>
    
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 400px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .status-btn { width: 200px; height: 200px; border-radius: 50%; border: none; font-size: 24px; font-weight: bold; cursor: pointer; transition: transform 0.2s; margin: 20px auto; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .status-btn:active { transform: scale(0.95); }
        .online { background-color: #4CAF50; color: white; }
        .offline { background-color: #f44336; color: white; }
        .provider-list { text-align: left; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .provider-item { background: #f9f9f9; padding: 12px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .network-status { font-size: 11px; color: #888; margin-bottom: 15px; padding: 5px; background: #eee; border-radius: 4px; display: inline-block;}
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // 1. ROBUST PEER LIST (Trying more options)
        const PEERS = [
            'https://gun-manhattan.herokuapp.com/gun',
            'https://gun-us.herokuapp.com/gun',
            'https://gun-eu.herokuapp.com/gun',
            'https://plato.design/gun',
            'https://peer.wallie.io/gun'
        ];

        const gun = Gun({ peers: PEERS });
        const user = gun.user();
        
        // Use a unique App ID so we don't get junk data from others
        const APP_ID = 'ippolive_pilot_v1_2'; 

        function App() {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [myStatus, setMyStatus] = React.useState('offline');
            const [pubKey, setPubKey] = React.useState('');
            const [providers, setProviders] = React.useState({});
            const [peersConnected, setPeersConnected] = React.useState(0);

            React.useEffect(() => {
                // LOGIN CHECK
                user.recall({sessionStorage: true}, (ack) => {
                    if (ack && ack.sea) {
                        setIsLoggedIn(true);
                        setPubKey(ack.sea.pub);
                    }
                });

                // CONNECTION MONITOR (Visual Feedback)
                // This counts how many relays we are successfully talking to
                setInterval(() => {
                    // Gun internal hack to count connected peers
                    const count = Object.keys(gun._.opt.peers).filter(k => gun._.opt.peers[k].wire && gun._.opt.peers[k].wire.readyState === 1).length;
                    setPeersConnected(count);
                }, 2000);

                // DATA LISTENER
                gun.get(APP_ID).map().on((data, key) => {
                    if(data) {
                        setProviders(prev => ({...prev, [key]: data}));
                    }
                });
            }, []);

            const login = () => {
                const pair = Gun.SEA.pair((pair) => {
                    user.auth(pair, () => {
                        setIsLoggedIn(true);
                        setPubKey(pair.pub);
                    });
                });
            };

            const toggleStatus = () => {
                const newStatus = myStatus === 'offline' ? 'online' : 'offline';
                setMyStatus(newStatus);
                if (navigator.vibrate) navigator.vibrate(50); 

                const data = { 
                    status: newStatus, 
                    lastUpdated: Date.now(),
                    name: "Dr. " + (pubKey ? pubKey.substring(0, 4) : "User")
                };
                
                user.get('profile').put(data);
                gun.get(APP_ID).get(pubKey).put(data);
            };

            return (
                <div className="app-container">
                    <h2>IppoLive Pilot v1.2</h2>
                    
                    {/* NETWORK MONITOR */}
                    <div className="network-status">
                        {peersConnected > 0 
                            ? <span style={{color:'green'}}>● Connected to {peersConnected} Relay(s)</span> 
                            : <span style={{color:'orange'}}>● Searching for Signal...</span>}
                    </div>

                    {!isLoggedIn ? (
                        <div style={{marginTop: '20px'}}>
                            <p>Are you a Service Provider?</p>
                            <button onClick={login} style={{padding: '12px 24px', fontSize: '16px', background: '#007bff', color: 'white', border: 'none', borderRadius: '5px', cursor: 'pointer'}}>
                                Initialize My Node
                            </button>
                        </div>
                    ) : (
                        <div>
                            <div style={{fontSize: '10px', color: '#aaa', margin: '10px 0'}}>Node ID: {pubKey.substring(0, 12)}...</div>
                            <button className={`status-btn ${myStatus}`} onClick={toggleStatus}>
                                {myStatus === 'online' ? "I AM IN" : "I AM OUT"}
                            </button>
                        </div>
                    )}

                    <div className="provider-list">
                        <h3>Live Neighborhood</h3>
                        {Object.keys(providers).length === 0 && <p style={{color:'#999'}}>Scanning mesh network...</p>}
                        
                        {Object.keys(providers).map(key => {
                            const p = providers[key];
                            // Dead Man Switch: 10 mins
                            const isStale = (Date.now() - p.lastUpdated) > 600000; 
                            const isOnline = !isStale && p.status === 'online';

                            return (
                                <div className="provider-item" key={key}>
                                    <div>
                                        <strong>{p.name || "Unknown"}</strong>
                                        <div style={{fontSize: '12px', color: '#888'}}>
                                            {isStale ? "⚠️ Signal Lost" : new Date(p.lastUpdated).toLocaleTimeString()}
                                        </div>
                                    </div>
                                    <div style={{display:'flex', alignItems:'center'}}>
                                        <span className="dot" style={{background: isStale ? 'grey' : (isOnline ? '#4CAF50' : '#f44336')}}></span>
                                        <span style={{fontWeight: 'bold', fontSize:'14px', color: isStale ? 'grey' : (isOnline ? '#4CAF50' : '#f44336')}}>
                                            {isStale ? "?" : (isOnline ? "OPEN" : "CLOSED")}
                                        </span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>